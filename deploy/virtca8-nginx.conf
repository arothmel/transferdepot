# ------------------------------------------------------------
# TransferDepot + MediaWiki bridge (virtca8)
# Revision: 2025-10-27
# ------------------------------------------------------------
# This nginx instance listens on port 80 for legacy hosts on the
# Analysis LAN. It serves TransferDepot via the local uWSGI socket
# and proxies MediaWiki requests to Sh1re so the legacy clients
# reach modern services without speaking HTTPS.
# ------------------------------------------------------------

user  tux;
worker_processes auto;

events {
    worker_connections 1024;
}

error_log  /home/tux/transferdepot/logs/virtca8-nginx.error.log  warn;
pid        /home/tux/transferdepot/logs/virtca8-nginx.pid;

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    sendfile on;
    tcp_nodelay on;
    keepalive_timeout 120s;
    reset_timedout_connection on;

    log_format main '$remote_addr - $remote_user [$time_local] '
                    '"$request" $status $body_bytes_sent '
                    '"$http_referer" "$http_user_agent" "$request_time"';

    access_log /home/tux/transferdepot/logs/virtca8-nginx.access.log main;

    upstream transferdepot_uwsgi {
        server unix:/home/tux/transferdepot/run/transferdepot.sock;
        keepalive 16;
    }

    upstream shire_mediawiki {
        server 10.32.36.138:80;
        keepalive 16;
    }

    server {
        listen 80;
        server_name virtca8 virtca8.internal;

        # TransferDepot static assets (served directly)
        location /static/ {
            alias /home/tux/transferdepot/static/;
            access_log off;
        }

        location /uploads/ {
            alias /home/tux/transferdepot/files/;
            autoindex on;
        }

        # TransferDepot UI and API (virtca8 local uWSGI)
        location / {
            include /etc/nginx/uwsgi_params;
            uwsgi_pass transferdepot_uwsgi;
            uwsgi_buffer_size 128k;
            uwsgi_buffers 16 128k;
            uwsgi_request_buffering off;
            uwsgi_read_timeout 3600s;
            uwsgi_send_timeout 3600s;
        }

        # MediaWiki paths (bridge to Sh1re/modern subnet)
        location /wiki/ {
            proxy_pass http://shire_mediawiki/wiki/;
            proxy_set_header Host 10.32.36.138;
            proxy_set_header X-Forwarded-For $remote_addr;
            proxy_set_header X-Forwarded-Proto http;
        }

        location ~ ^/index\.php(/.*)?$ {
            proxy_pass http://shire_mediawiki$request_uri;
            proxy_set_header Host 10.32.36.138;
            proxy_set_header X-Forwarded-For $remote_addr;
            proxy_set_header X-Forwarded-Proto http;
        }
    }
}
